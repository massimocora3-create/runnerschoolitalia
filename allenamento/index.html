<script>
(async () => {

  const weekBox = document.getElementById("week");
  weekBox.innerHTML = "";

  /* ===============================
     CLICK SUI LIVELLI
  =============================== */
  document.querySelectorAll(".level").forEach(btn => {
    btn.addEventListener("click", () => {
      const url = new URL(location.href);
      url.searchParams.set("level", btn.dataset.level);
      location.href = url.toString();
    });
  });

  const params = new URLSearchParams(location.search);
  const level = params.get("level");
  if (!level) return;

  document.querySelectorAll(".level").forEach(l => {
    if (l.dataset.level === level) l.classList.add("active");
  });

  /* ===============================
     DATA DI OGGI (YYYY-MM-DD)
  =============================== */
  const today = new Date().toISOString().slice(0, 10);

  /* ===============================
     FETCH PROGRAMMA COMPLETO
  =============================== */
  const res = await fetch("../programma/index.html", { cache: "no-store" });
  const html = await res.text();

  const temp = document.createElement("div");
  temp.innerHTML = html;

  /* ===============================
     TROVA LIVELLO
  =============================== */
  const levelBlock = temp.querySelector(
    `details.level[data-level="${level}"]`
  );

  if (!levelBlock) {
    weekBox.innerHTML = "<p>Livello non trovato</p>";
    return;
  }

  /* ===============================
     TROVA SETTIMANA CORRENTE
  =============================== */
  const weeks = [...levelBlock.querySelectorAll("details.week")];

  const currentWeek = weeks.find(w =>
    today >= w.dataset.start && today <= w.dataset.end
  );

  if (!currentWeek) {
    weekBox.innerHTML = "<p>Nessuna settimana attiva</p>";
    return;
  }

  /* ===============================
     CLONA E MOSTRA
  =============================== */
  const cloned = currentWeek.cloneNode(true);
  cloned.open = true;

  weekBox.appendChild(cloned);

})();
</script>

