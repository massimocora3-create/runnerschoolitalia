<script>
(async function () {

  const container = document.getElementById("week-container");
  const buttons = document.querySelectorAll('#level-list .level-btn');

  // Data odierna ISO
  const today = new Date();
  const todayISO =
    today.getFullYear() + "-" +
    String(today.getMonth()+1).padStart(2,"0") + "-" +
    String(today.getDate()).padStart(2,"0");

  // URL programma completo
  const programURL = "../programma/index.html";

  let programHTML = "";
  try {
    const res = await fetch(programURL, { cache: "no-store" });
    if (!res.ok) throw new Error();
    programHTML = await res.text();
  } catch {
    container.innerHTML = "<p>❌ Errore nel caricamento del programma</p>";
    return;
  }

  const temp = document.createElement("div");
  temp.innerHTML = programHTML;

  // CLICK SUI BOTTONI
  buttons.forEach(btn => {
    btn.addEventListener("click", () => {

      // reset stato
      buttons.forEach(b => b.classList.remove("active"));
      container.innerHTML = "";

      btn.classList.add("active");
      const level = btn.dataset.level;

      // trova blocco livello
      const levelBlock = temp.querySelector(
        `details.level[data-level="${level}"]`
      );

      if (!levelBlock) {
        container.innerHTML = `<p>❌ Livello ${level} non trovato</p>`;
        return;
      }

      // trova settimana corrente
      const weeks = [...levelBlock.querySelectorAll(
        'details.week[data-start][data-end]'
      )];

      const currentWeek = weeks.find(w => {
        const start = w.dataset.start;
        const end = w.dataset.end;
        return todayISO >= start && todayISO <= end;
      });

      if (!currentWeek) {
        container.innerHTML = "<p>⏸ Nessuna settimana attiva</p>";
        return;
      }

      // settimana CHIUSA di default
      const clone = currentWeek.cloneNode(true);
      clone.open = false;

      container.appendChild(clone);
    });
  });

})();
</script>

